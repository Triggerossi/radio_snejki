<!DOCTYPE html>
<html>

<head>
    <title>Radio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .player {
            text-align: center;
            background: #2c2c2c;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            width: 300px;
        }

        .cover {
            width: 250px;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .song-info h2 {
            margin: 10px 0 5px;
            font-size: 24px;
        }

        .song-info p {
            margin: 5px 0;
            color: #aaa;
        }

        .likes {
            color: #ff6f81;
            font-size: 14px;
            margin: 10px 0;
        }

        .controls button {
            background: #ff4b5c;
            border: none;
            color: #fff;
            padding: 12px 24px;
            margin: 8px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .controls button:hover {
            background: #ff6f81;
        }

        .controls button.liked {
            background: #ff6f81;
        }

        .controls button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .controls .reset-btn {
            background: #444;
            font-size: 14px;
            padding: 10px 16px;
        }

        .controls .reset-btn:hover {
            background: #666;
        }

        audio {
            width: 100%;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="player">
        {% if song.cover %}
        <img src="{{ song.cover.url }}" alt="Cover" class="cover" id="cover-img">
        {% else %}
        <div class="cover" style="background: #333;"></div>
        {% endif %}

        <div class="song-info">
            <h2 id="song-title">{{ song.title }}</h2>
            <p id="song-artist-genre">{{ song.author.name }} ‚Äî {{ song.genre.name }}</p>
            <p class="likes">‚ù§Ô∏è <span id="like-count">{{ song.likes_count|default:0 }}</span> likes</p>
        </div>

        <audio id="audio-player" controls autoplay preload="auto">
            <source src="{{ song.file.url }}" type="audio/mpeg">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
        </audio>

        <div class="controls">
            <button id="like-btn" data-song-id="{{ song.id }}">
                {% if song.is_liked %}‚ù§Ô∏è Liked{% else %}‚ù§Ô∏è Like{% endif %}
            </button>
            <button id="next-btn">‚è≠ Next</button>
            <br>
            <button id="reset-likes-btn" class="reset-btn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–∞–π–∫–∏</button>
        </div>
    </div>

    <script>
        const audio = document.getElementById('audio-player');
        const likeBtn = document.getElementById('like-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-likes-btn');
        const coverImg = document.getElementById('cover-img');
        const titleEl = document.getElementById('song-title');
        const artistGenreEl = document.getElementById('song-artist-genre');
        const likeCountEl = document.getElementById('like-count');

        const csrfToken = '{{ csrf_token }}';
        let isLoading = false;

        // –õ–∞–π–∫ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
        likeBtn.addEventListener('click', function () {
            if (this.disabled) return;

            const songId = this.dataset.songId;
            fetch(`/like/${songId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    likeBtn.textContent = '‚ù§Ô∏è Liked';
                    likeBtn.classList.add('liked');
                    likeBtn.disabled = true;
                    likeCountEl.textContent = parseInt(likeCountEl.textContent) + 1;
                }
            });
        });

        // –°–±—Ä–æ—Å –≤—Å–µ—Ö –ª–∞–π–∫–æ–≤
        resetBtn.addEventListener('click', function () {
            if (!confirm('–¢—ã —É–≤–µ—Ä–µ–Ω? –í—Å–µ —Ç–≤–æ–∏ –ª–∞–π–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) return;

            fetch('/reset-likes/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    alert('–í—Å–µ –ª–∞–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã! –†–∞–¥–∏–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.');
                    location.reload();  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
                }
            })
            .catch(err => {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ª–∞–π–∫–æ–≤');
            });
        });

        // –°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
        function loadNextSong() {
            if (isLoading) return;
            isLoading = true;
            nextBtn.disabled = true;
            nextBtn.textContent = '‚è≥ Loading...';

            const currentId = likeBtn.dataset.songId;

            fetch(`/next-song/?current_id=${currentId}`)
                .then(res => {
                    if (!res.ok) throw new Error('Network error');
                    return res.json();
                })
                .then(data => {
                    if (!data || !data.id) {
                        console.log('–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤');
                        return;
                    }

                    if (data.id == currentId) {
                        audio.currentTime = 0;
                        audio.play();
                        isLoading = false;
                        nextBtn.disabled = false;
                        nextBtn.textContent = '‚è≠ Next';
                        return;
                    }

                    titleEl.textContent = data.title;
                    artistGenreEl.textContent = `${data.author} ‚Äî ${data.genre}`;
                    likeCountEl.textContent = data.likes_count || 0;

                    if (data.cover_url && coverImg) {
                        coverImg.src = data.cover_url;
                    }

                    likeBtn.dataset.songId = data.id;
                    likeBtn.textContent = data.is_liked ? '‚ù§Ô∏è Liked' : '‚ù§Ô∏è Like';
                    likeBtn.classList.toggle('liked', data.is_liked);
                    likeBtn.disabled = data.is_liked;

                    audio.src = data.file_url;
                    audio.load();
                    audio.play().catch(e => console.log('Play prevented:', e));
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫');
                })
                .finally(() => {
                    isLoading = false;
                    nextBtn.disabled = false;
                    nextBtn.textContent = '‚è≠ Next';
                });
        }

        nextBtn.addEventListener('click', loadNextSong);
        audio.addEventListener('ended', loadNextSong);

        audio.addEventListener('error', () => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ');
            isLoading = false;
            nextBtn.disabled = false;
            nextBtn.textContent = '‚è≠ Next';
        });
    </script>
</body>

</html>