<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>My Radio</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background: #000 center/cover no-repeat;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-image 1.2s ease-in-out;
        }

        /* –†–∞–∑–º—ã—Ç—ã–π —Ñ–æ–Ω —Å –æ–±–ª–æ–∂–∫–æ–π */
        body::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -10%;
            right: -10%;
            bottom: -10%;
            background: inherit;
            background-size: cover;
            background-position: center;
            filter: blur(50px) saturate(180%) brightness(0.5);
            z-index: -2;
            transform: scale(1.2);
        }

        /* –¢—ë–º–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π */
        body::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.8) 100%);
            z-index: -1;
        }

        .player {
            position: relative;
            z-index: 1;
            text-align: center;
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            width: 400px;
            max-width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cover {
            width: 300px;
            height: 300px;
            object-fit: cover;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
            transition: transform 0.3s ease;
        }

        .cover:hover {
            transform: scale(1.05);
        }

        .song-info h2 {
            font-size: 28px;
            margin: 0 0 10px;
            font-weight: 700;
        }

        .song-info p {
            font-size: 18px;
            color: #ccc;
            margin: 5px 0;
        }

        .likes {
            font-size: 18px;
            color: #ff4b5c;
            margin: 20px 0;
        }

        audio {
            width: 100%;
            margin: 25px 0;
            outline: none;
        }

        .controls {
            margin-top: 20px;
        }

        .controls button {
            background: #ff4b5c;
            border: none;
            color: white;
            padding: 14px 28px;
            margin: 8px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .controls button:hover {
            background: #ff6f81;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 75, 92, 0.4);
        }

        .controls button.liked {
            background: #ff6f81;
        }

        .controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #dislike-btn {
            background: #666;
        }

        #dislike-btn:hover {
            background: #888;
        }

        .reset-btn {
            background: #444 !important;
            font-size: 15px;
            padding: 10px 20px;
        }

        .reset-btn:hover {
            background: #555 !important;
        }

        #visualizer {
            width: 360px;
            height: 120px;
            margin: 30px auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body>
    <div class="player">
        {% if song.cover %}
        <img src="{{ song.cover.url }}" alt="Cover" class="cover" id="cover-img">
        {% else %}
        <div class="cover" style="background: #333;"></div>
        {% endif %}

        <div class="song-info">
            <h2 id="song-title">{{ song.title }}</h2>
            <p id="song-artist-genre">{{ song.author.name }} ‚Äî {{ song.genre.name }}</p>
            <p class="likes">‚ù§Ô∏è <span id="like-count">{{ song.likes_count|default:0 }}</span> likes</p>
        </div>

        <audio id="audio-player" controls autoplay preload="auto">
            <source src="{{ song.file.url }}" type="audio/mpeg">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
        </audio>

        <canvas id="visualizer"></canvas>

        <div class="controls">
            <button id="like-btn" data-song-id="{{ song.id }}">
                {% if song.is_liked %}‚ù§Ô∏è Liked{% else %}‚ù§Ô∏è Like{% endif %}
            </button>
            <button id="dislike-btn">üö´ –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è</button>
            <button id="next-btn">‚è≠ Next</button>
            <br>
            <button id="reset-likes-btn" class="reset-btn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–∞–π–∫–∏</button>
        </div>
    </div>

    <script>
        const audio = document.getElementById('audio-player');
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-likes-btn');
        const coverImg = document.getElementById('cover-img');
        const titleEl = document.getElementById('song-title');
        const artistGenreEl = document.getElementById('song-artist-genre');
        const likeCountEl = document.getElementById('like-count');

        const csrfToken = '{{ csrf_token }}';
        let isLoading = false;

        // === –§–û–ù –° –û–ë–õ–û–ñ–ö–û–ô ===
        function updateBackground() {
            const url = coverImg && coverImg.src ? coverImg.src : 'https://via.placeholder.com/300?text=No+Cover';
            document.body.style.backgroundImage = `url(${url})`;
        }

        if (coverImg && coverImg.complete) updateBackground();
        else if (coverImg) coverImg.onload = updateBackground;

        // === –õ–ê–ô–ö ===
        likeBtn.addEventListener('click', function () {
            if (this.disabled) return;
            const songId = this.dataset.songId;
            fetch(`/like/${songId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    likeBtn.textContent = '‚ù§Ô∏è Liked';
                    likeBtn.classList.add('liked');
                    likeBtn.disabled = true;
                    likeCountEl.textContent = parseInt(likeCountEl.textContent) + 1;
                }
            });
        });

        // === –î–ò–ó–õ–ê–ô–ö (–ò–°–ü–†–ê–í–õ–ï–ù–û: –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π) ===
        dislikeBtn.addEventListener('click', function () {
            if (!confirm('–≠—Ç–æ—Ç —Ç—Ä–µ–∫ –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –∏–≥—Ä–∞—Ç—å. –£–≤–µ—Ä–µ–Ω?')) return;

            const songId = likeBtn.dataset.songId;

            fetch(`/dislike/${songId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(res => {
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–∏–∑–ª–∞–π–∫–∞');
                return res.json();
            })
            .then(() => {
                alert('–¢—Ä–µ–∫ –ø—Ä–æ–ø—É—â–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞');
                loadNextSong(true);  // forceNext = true ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω—è–µ–º —Ç—Ä–µ–∫
            })
            .catch(err => {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ');
            });
        });

        // === –°–ë–†–û–° ===
        resetBtn.addEventListener('click', function () {
            if (!confirm('–¢—ã —É–≤–µ—Ä–µ–Ω? –í—Å–µ —Ç–≤–æ–∏ –ª–∞–π–∫–∏, –¥–∏–∑–ª–∞–π–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) return;
            fetch('/reset-likes/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    alert('–í—Å—ë —Å–±—Ä–æ—à–µ–Ω–æ!');
                    location.reload();
                }
            });
        });

        // === –°–õ–ï–î–£–Æ–©–ò–ô –¢–†–ï–ö ===
        function loadNextSong(forceNext = false) {
            if (isLoading) return;
            isLoading = true;
            nextBtn.disabled = true;
            nextBtn.textContent = '‚è≥';

            const currentId = likeBtn.dataset.songId;

            fetch(`/next-song/?current_id=${currentId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.id) {
                        console.log('–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤');
                        isLoading = false;
                        nextBtn.disabled = false;
                        nextBtn.textContent = '‚è≠ Next';
                        return;
                    }

                    // –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π next –∏ –≤–µ—Ä–Ω—É–ª—Å—è —Ç–æ—Ç –∂–µ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–∞—á–∞–ª–∞
                    if (data.id == currentId && !forceNext) {
                        audio.currentTime = 0;
                        audio.play();
                        isLoading = false;
                        nextBtn.disabled = false;
                        nextBtn.textContent = '‚è≠ Next';
                        return;
                    }

                    // –ü–æ–ª–Ω–∞—è —Å–º–µ–Ω–∞ —Ç—Ä–µ–∫–∞ (–¥–ª—è next –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫–∞)
                    titleEl.textContent = data.title;
                    artistGenreEl.textContent = `${data.author} ‚Äî ${data.genre}`;
                    likeCountEl.textContent = data.likes_count || 0;

                    if (data.cover_url && coverImg) {
                        coverImg.onload = updateBackground;
                        coverImg.src = data.cover_url;
                    } else {
                        updateBackground();
                    }

                    likeBtn.dataset.songId = data.id;
                    likeBtn.textContent = data.is_liked ? '‚ù§Ô∏è Liked' : '‚ù§Ô∏è Like';
                    likeBtn.classList.toggle('liked', data.is_liked);
                    likeBtn.disabled = data.is_liked;

                    audio.pause();
                    audio.src = data.file_url;
                    audio.load();

                    // –ù–∞–¥—ë–∂–Ω—ã–π play
                    audio.oncanplaythrough = audio.oncanplay = () => {
                        audio.oncanplaythrough = audio.oncanplay = null;
                        audio.play().catch(() => {});
                    };
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–∫–∞:', err);
                })
                .finally(() => {
                    isLoading = false;
                    nextBtn.disabled = false;
                    nextBtn.textContent = '‚è≠ Next';
                });
        }

        nextBtn.addEventListener('click', () => loadNextSong());
        audio.addEventListener('ended', () => loadNextSong());

        // === –í–ò–ó–£–ê–õ–ê–ô–ó–ï–† ===
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        canvas.width = 360;
        canvas.height = 120;

        let audioContext = null;
        let analyser = null;
        let source = null;
        let dataArray = null;
        let visualizerStarted = false;

        function initVisualizer() {
            if (visualizerStarted) return;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                analyser.fftSize = 512;

                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                visualizerStarted = true;
                drawVisualizer();
            } catch (e) {
                console.error('–í–∏–∑—É–∞–ª–∞–π–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', e);
            }
        }

        function drawVisualizer() {
            if (!visualizerStarted) return;
            requestAnimationFrame(drawVisualizer);

            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height * 0.9;

                const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                gradient.addColorStop(0, '#ff4b5c');
                gradient.addColorStop(0.5, '#ff8fa3');
                gradient.addColorStop(1, '#ffb1c1');

                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);
                x += barWidth;
            }
        }

        // –ó–∞–ø—É—Å–∫ –≤–∏–∑—É–∞–ª–∞–π–∑–µ—Ä–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
        function startVisualizer() {
            initVisualizer();
            document.removeEventListener('click', startVisualizer);
            document.removeEventListener('touchstart', startVisualizer);
        }

        document.addEventListener('click', startVisualizer);
        document.addEventListener('touchstart', startVisualizer);

        // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
        audio.addEventListener('play', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>